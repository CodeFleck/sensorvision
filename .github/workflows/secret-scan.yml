name: Secret Scanning

on:
  push:
    branches: [main, develop, 'feature/**', 'security/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning all commits

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.82.5
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional for enterprise features

  credential-patterns:
    name: Custom Credential Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded credentials
        run: |
          echo "Scanning for potential hardcoded credentials..."

          # Define patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]{8,}['\"]"
            "secret\s*=\s*['\"][^'\"]{8,}['\"]"
            "api_key\s*=\s*['\"][^'\"]{8,}['\"]"
            "token\s*=\s*['\"][^'\"]{16,}['\"]"
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "ghp_[a-zA-Z0-9]{36}"  # GitHub Personal Access Token
            "gho_[a-zA-Z0-9]{36}"  # GitHub OAuth Token
            "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----"
          )

          # Files/paths to exclude from scanning (test files, examples, docs, static assets)
          EXCLUDE_PATTERNS="\.example|\.template|\.md|secret-scan\.yml|SECURITY\.md|Test\.java|\.test\.ts|\.test\.js|test_.*\.js|/static/assets/|node_modules|\.spec\."

          FOUND_SECRETS=0

          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            # Search source files, excluding test files and static assets
            MATCHES=$(grep -rEi --include="*.java" --include="*.properties" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.ts" --include="*.js" --include="*.env" "$pattern" . 2>/dev/null | grep -vE "$EXCLUDE_PATTERNS" || true)
            if [ -n "$MATCHES" ]; then
              echo "$MATCHES"
              echo "WARNING: Potential secret found matching pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done

          if [ $FOUND_SECRETS -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo "SECURITY ERROR: Potential secrets detected!"
            echo "Please review the findings above and ensure"
            echo "no real credentials are being committed."
            echo "=========================================="
            # Fail the build to prevent secret commits
            exit 1
          else
            echo "No obvious credential patterns detected."
          fi

      - name: Check for .env files
        run: |
          echo "Checking for accidentally committed .env files..."
          if find . -name ".env" -not -name ".env.example" -not -name ".env.*.template" -type f | grep -v node_modules | grep -v ".git"; then
            echo "WARNING: .env file found! Ensure it's in .gitignore"
          else
            echo "No .env files found in tracked files."
          fi